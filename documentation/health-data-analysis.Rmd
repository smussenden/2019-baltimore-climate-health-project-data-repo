---
title: "Health Story Data Analysis"
author: "Roxanne Ready, Sean Mussenden, Theresa Diffendal | Howard Center for Investigative Journalism"
date: "8/6/2019"
output: 
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 3
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
---

```{r include=FALSE}
# Save this file and run the following line from the Console to output both HTML and .md formats:
# rmarkdown::render('documentation/health-data-analysis.Rmd', output_format = 'all')
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, paged.print=TRUE)
```

## Introduction

This R markdown document describes the methodology and results of a portion of the data analysis for a reporting project examining the effects of climate change and temperature increases on the health of people in Baltimore's hottest neighborhoods.  

This story was written by 

In general, this document is arranged into analyses of the following categories, though there are some cases where one statistic depends on multiple categories (e.g. the canopy cover in a hot neighborhood):

* Temperature
* Demographics
* Tree Canopy
* Street Trees (individual tree tracking)

## Setup

Before running this file, **please view and run the [Code Red Data Cleaning document](https://github.com/smussenden/2019-baltimore-climate-health-project-data-repo/blob/master/documentation/code-red-data-cleaning.md)** for this project. As well as outputting necessary cleaned data for the following ananlysis, that document also includes the following items necessary to understand this analysis: 

* definitions
* source data citation and information
* cleaning methodology 
* software tools used

### Load packages

```{r}
#######################
#### Load Packages ####
#######################

library(tidyverse)
library(DescTools) # For %like% operator
library(corrr) # For correlation matrices
library(colorspace) # For improved color palettes
library(ggplot2) # For graphing
library(ggrepel) # For graph labeling
require(scales) # For percent labeling on distribution tables
#library(here) # For cleaner file path writing

# Turn off scientific notation in RStudio (prevents coersion to character type)
options(scipen = 999)
```

### Load variables and data

```{r}
#########################
#### Store Variables ####
#########################

#### Common path to data ####
path_to_data <- "../data/output-data/cleaned/"

###################
#### Load Data ####
###################

# Sensor Data
path_to_data <- "../data/output-data/temperature_sensors/michael/"
michael_day_hourly_averages <- read_csv(paste0(path_to_data, "michael_day_hourly_averages.csv"))

path_to_data <- "../data/output-data/temperature_sensors/stephanie/"
stephanie_day_minute_averages <- read_csv(paste0(path_to_data, "stephanie_day_minute_averages.csv"))

path_to_data <- "../data/output-data/temperature_sensors/audrey/"
audrey_day_minute_averages <- read_csv(paste0(path_to_data, "audrey_day_minute_averages.csv"))
audrey_day_hourly_averages <- read_csv(paste0(path_to_data, "audrey_day_hourly_averages.csv"))

write_csv(stephanie_day_minute_averages, paste0(save_path, "stephanie_day_minute_averages.csv"))



# Inner Harbor temperature data
path_to_data <- "../data/output-data/baltimore_weather_stations/"
dmh <- read_csv(paste0(path_to_data, "dmh.csv"))

# EMS data
path_to_data <- "../data/output-data/ems/"
EMS_all <- read_csv(paste0(path_to_data, "EMS_all.csv"))
dmh_ems <- read_csv(paste0(path_to_data, "dmh_ems.csv"))


write_csv(stephanie_day_averages, paste0(save_path, "stephanie_day_averages.csv"))
write_csv(stephanie_day_hourly_averages, paste0(save_path, "stephanie_day_hourly_averages.csv"))

save_path <- "../data/output-data/temperature_sensors/tammy/"
write_csv(tammy_day_averages, paste0(save_path, "tammy_day_averages.csv"))
write_csv(tammy_day_hourly_averages, paste0(save_path, "tammy_day_hourly_averages.csv"))
write_csv(tammy_day_minute_averages, paste0(save_path, "tammy_day_minute_averages.csv"))
save_path <- "../data/output-data/temperature_sensors/michael/"
write_csv(michael_day_averages, paste0(save_path, "michael_day_averages.csv"))
write_csv(michael_day_hourly_averages, paste0(save_path, "michael_day_hourly_averages.csv"))
write_csv(michael_day_minute_averages, paste0(save_path, "michael_day_minute_averages.csv"))
save_path <- "../data/output-data/temperature_sensors/audrey/"
write_csv(audrey_day_averages, paste0(save_path, "audrey_day_averages.csv"))
write_csv(audrey_day_hourly_averages, paste0(save_path, "audrey_day_hourly_averages.csv"))
write_csv(audrey_day_minute_averages, paste0(save_path, "audrey_day_minute_averages.csv"))



write_csv(michael_day_minute_averages, paste0(save_path, "michael_day_minute_averages.csv"))



EMS_all <- read_csv(paste0(path_to_data, "EMS_all.csv"))
dmh_ems <- read_csv(paste0(path_to_data, "dmh_ems.csv"))

stephanie_day_averages<- read_csv(paste0(path_to_data, "stephanie_day_averages.csv"))
stephanie_day_hourly_averages <- read_csv(paste0(path_to_data, "stephanie_day_hourly_averages.csv"))
stephanie_day_minute_averages <- read_csv(paste0(path_to_data, "stephanie_day_minute_averages.csv"))
tammy_day_averages <- read_csv(paste0(path_to_data, "tammy_day_averages.csv"))
tammy_day_hourly_averages <- read_csv(paste0(path_to_data, "tammy_day_hourly_averages.csv"))
tammy_day_minute_averages <- read_csv(paste0(path_to_data, "tammy_day_minute_averages.csv"))
michael_day_averages<- read_csv(paste0(path_to_data, "michael_day_averages.csv"))
michael_day_hourly_averages <- read_csv(paste0(path_to_data, "michael_day_hourly_averages.csv"))
michael_day_minute_averages <- read_csv(paste0(path_to_data, "michael_day_minute_averages.csv"))
audrey_day_averages<- read_csv(paste0(path_to_data, "audrey_day_averages.csv"))
audrey_day_hourly_averages <- read_csv(paste0(path_to_data, "audrey_day_hourly_averages.csv"))
audrey_day_minute_averages <- read_csv(paste0(path_to_data, "audrey_day_minute_averages.csv"))
nsa_tree_temp <- read_csv(paste0(path_to_data,"nsa_tree_temp.csv"))
blocks_tree_temp_demographics <- read_csv(paste0(path_to_data, "blocks_tree_temp_demographics.csv"))
# Emergency Room by Zip Code
write_csv(op_er_full_zip_correlation_matrix, paste0(save_path, "op_er_full_zip_correlation_matrix.csv"))
write_csv(op_er_full_zip_disease_heat, paste0(save_path, "op_er_full_zip_disease_heat.csv"))

# Medicaid Inpatient by Zip Code
write_csv(ip_full_zip_medicaid_correlation_matrix, paste0(save_path, "ip_full_zip_medicaid_correlation_matrix.csv"))
write_csv(ip_full_zip_medicaid_disease_heat, paste0(save_path, "ip_full_zip_medicaid_disease_heat.csv"))

# Medicaid Emergency Room by ZipCode
write_csv(op_er_full_zip_medicaid_correlation_matrix, paste0(save_path, "op_er_full_zip_medicaid_correlation_matrix.csv"))
write_csv(op_er_full_zip_medicaid_disease_heat, paste0(save_path, "op_er_full_zip_medicaid_disease_heat.csv"))


#### Write to CSV ####

# Tree Canopy, Heat Island Temperature, Demographics
# updatesave path ####
save_path <- "../data/output-data/tree_temp_demographics/"
write_csv(blocks_tree_temp_population, paste0(save_path, "blocks_tree_temp_demographics.csv"))
write_csv(csa_tree_temp_demographics, paste0(save_path, "csa_tree_temp_demographics.csv"))
write_csv(nsa_tree_temp, paste0(save_path, "nsa_tree_temp.csv"))
write_csv(zcta_temp_demographics, paste0(save_path, "zcta_temp_demographics.csv"))

# Street Trees
save_path <- "../data/output-data/street_trees/"
write_csv(street_trees_categorized, paste0(save_path, "street_trees_nsa_categorized.csv"))
write_csv(master_street_trees_by_nsa,  paste0(save_path, "street_trees_nsa_summarized.csv"))
write_csv(cctv_cameras_street_trees, paste0(save_path, "cctv_cameras_street_trees.csv"))

# Redlining and Trees
save_path <- "../data/output-data/redlining_trees/"
write_csv(redlining_tree, paste0(save_path, "redlining_tree.csv"))

# For EMS analysis
save_path <- "../data/output-data/ems/"
write_csv(EMS_all, paste0(save_path, "EMS_all.csv"))
write_csv(dmh_ems, paste0(save_path, "dmh_ems.csv"))

# Weather Station Data
save_path <- "../data/output-data/baltimore_weather_stations/"
write_csv(estimated_historical_dmh, paste0(save_path, "estimated_historical_dmh.csv"))
write_csv(dmh, paste0(save_path, "dmh.csv"))
write_csv(bwi, paste0(save_path, "bwi.csv"))



# Hospital Data 
# Inpatient by Zip Code
save_path <- "../data/output-data/hospital_data/ip/"
write_csv(ip_full_zip_correlation_matrix, paste0(save_path, "ip_full_zip_correlation_matrix.csv"))
write_csv(ip_full_zip_disease_heat, paste0(save_path, "ip_full_zip_disease_heat.csv"))
# Medicaid Inpatient by Zip Code
write_csv(ip_full_zip_medicaid_correlation_matrix, paste0(save_path, "ip_full_zip_medicaid_correlation_matrix.csv"))
write_csv(ip_full_zip_medicaid_disease_heat, paste0(save_path, "ip_full_zip_medicaid_disease_heat.csv"))

# Emergency Room by Zip Code
save_path <- "../data/output-data/hospital_data/op_er/"
write_csv(op_er_full_zip_correlation_matrix, paste0(save_path, "op_er_full_zip_correlation_matrix.csv"))
write_csv(op_er_full_zip_disease_heat, paste0(save_path, "op_er_full_zip_disease_heat.csv"))
# Medicaid Emergency Room by ZipCode
write_csv(op_er_full_zip_medicaid_correlation_matrix, paste0(save_path, "op_er_full_zip_medicaid_correlation_matrix.csv"))
write_csv(op_er_full_zip_medicaid_disease_heat, paste0(save_path, "op_er_full_zip_medicaid_disease_heat.csv"))


#### Clean up the workspace ####

####################################
######## Define Functions ##########
####################################

# Function to save each matrix as CSV
write_matrix_csv <- function(dataframe) {
  # Store dataframe name for later use
  dataframe_name <- deparse(substitute(dataframe))
  
  # Create filename for csv
  filename <- paste0("data/output-data/correlation_matrices/", dataframe_name,".csv")
  
  # Write out csv  
  write_csv(dataframe, path = filename)
  
} 

# Function to make a nice little correlation matrix heatmap for each graphic

make_correlation_matrix_graphic <- function(dataframe, grouping = "GROUPING") {
  
  # Store name of dataframe for use in title
  dataframe_name <- deparse(substitute(dataframe))
  
  # Build chart title
  chart_title <- paste0("Correlations by ", grouping, " in Baltimore City | ", dataframe_name )
  
  # Create graph
  ggplot(data = dataframe, aes(x = variable_2, y = variable)) +
    geom_tile(aes(fill = value)) +
    scale_fill_gradient2(low = "blue", high = "red", mid="white", midpoint=0) +
    geom_text(aes(label = round(value, 2)*100), size = 10) +
    ggtitle(chart_title) +
    theme(axis.text=element_text(size=14),
          axis.text.x = element_text(size=14,angle=50,hjust=1),
          plot.title = element_text(size=14)
    )
  # Create filename and filepath to save image. 
  filename <- paste0(dataframe_name,".png")
  ggsave(filename, plot = last_plot(), device = "png", path = "data/output-data/plots/correlation-matrix-images", scale = 1, width = 20, height = 20, units = "in", dpi = 300)
  
}  

select_x <- function(df){
  return(df %>%
           select_if(is.numeric) 
           # select(-matches("objectid"), 
           #        -matches("csa2010"), 
           #        -matches("id"), 
           #        -matches("09"), 
           #        -matches("1718"), 
           #        -matches("change_percent")
           #        )
         )
}

```


## Line-By-Line Fact-Check

### Fact: 96 Degrees in Michael Thomas and Alberta Wilkerson's Apartment

"As the temperature in their rowhouse apartment rose to a humid 96 degrees F during a summer heat wave, Michael Thomas and Alberta Wilkerson sat on their bed, in front of fans, wiping sweat and drinking water, trying to keep their minds off the heat."

#### Explanation

Reporter Ian Round spent time with Michael Thomas and Alberta Wilkerson in the afternoon of July 20, 2019, and observed this scene.  On July 20, 2019, the average temperature between 4 and 5 p.m. in their home was 96.0 degrees, with a heat index of 109.2. 

#### Supporting Code
```{r}

 michael_day_hourly_averages %>%
  mutate(date = date(date_hour)) %>%
  mutate(hour = hour(date_hour)) %>%
  filter(date == "2019-07-20",
         hour == 16) 

```

### Fact: July 2019 Heat Wave

"...the scorching 11-day stretch in July, including two days when outdoor temperatures hit 100 degrees..."

#### Explanation

July 12-22 had maximum temperatures at the NWS's Inner Harbor weather station of at least 90 degrees F and max heat indexes of at least 92 F. This uses hourly averages.  The table below shows on only one day was there an hourly average of 100 degrees, July 21.  Using a different dataset from the NCDC, the official maximum for each day, which is calculated using minute-by-minute readings, shows it 100 on July 20 and 101 on July 21. 

#### Supporting Code
```{r}

 dmh %>%
  filter(month == 7,
         year == 2019,
         day >=12, 
         day <= 22) %>%
  group_by(`date`) %>%
  summarise(min_temp = min(avg_hourly_temperature_dmh),
            max_temp = max(avg_hourly_temperature_dmh),
            mean_temp = mean(avg_hourly_temperature_dmh),
            min_heat_index = min(avg_hourly_heat_index_dmh),
            max_heat_index = max(avg_hourly_heat_index_dmh),
            mean_heat_index = mean(avg_hourly_heat_index_dmh) 
  )


```

### Fact: Heat Index in Michael Thomas and Alberta Wilkerson's Apartment

"At 10:30 p.m. on July 18, the heat index in their living quarters reached a high of 116 degrees, according to a sensor they allowed reporters from the University of Maryland’s Howard Center for Investigative Journalism and Capital News Service to place in their home for several weeks." 

"That was 22 degrees hotter than the heat index outdoors."

#### Explanation

At 10:30 p.m. inside their apartment on July 18, the temperature was 94.5 degrees, but the humidity inside pushed the heat index to 116 degrees. The heat index at the time at the NWS' Inner Harbor monitoring station was 94 degrees.  It was 22 degrees hotter inside their apartment than it was at the Inner Harbor, using the heat index as a metric. 

#### Supporting Code
``` {r}

michael_day_minute_averages %>%
  arrange(desc(mean_indoor_heat_index)) %>%
  mutate(date = date(date_hour_minute)) %>%
  mutate(hour = hour(date_hour_minute)) %>%
  mutate(minute = minute(date_hour_minute)) %>%
  filter(date == "2019-07-18",
         hour == 22,
         minute == 30)



```

### Fact: EMS calls for certain conditions spike when it gets very hot

"That helps explain why, during the summer in Baltimore, emergency medical calls for dehydration, respiratory distress, kidney disease, diabetes complications, heart attacks and heart failure spiked when the heat index rose above 103 degrees, according to a Howard Center data analysis." 

### Explanation

Using emergency medical call records from Baltimore City, we examined calls during Summer 2018.  They were aligned to heat index data captured at the Inner Harbor and adjusted for the urban heat island using the ZIP Code of each call location.  The statistics in the table below represent the number of hours that passed between calls for select conditions when the temperature was in a given heat index bucket. 

For example, in Summer 2018, when the heat index was under 80 degrees, there was a medical call for dehydration every 41 hours.  When the heat index hit 103 degrees, the rate of calls increased dramatically -- to one every 2.2 hours.  We saw less dramatic increases for cardiac arrest (a call every 5 hours to a call every 3 hours) and other chronic conditions. 

#### Supporting Code
``` {r}

# Select conditions
conditions <- c("Dehydration","Respiratory Distress", "COPD (Emphysema/Chronic Bronchitis)", "End Stage Renal Disease", "Diabetic Hyperglycemia", "Diabetic Hypoglycemia", "Cardiac Arrest", "CHF (Congestive Heart Failure)")


# Calculate the total number of hours over the course of Summer 2018 that the heat index fell into each heat index level, as defined by the national weather service: not unsafe (under 80), caution (80-89), extreme caution (90-102), danger (103-124).   

heat_index_count_per_nws_five_scale_bucket <- dmh_ems %>%
  select(heat_index_nws_five_scale_bucket) %>%
  group_by(heat_index_nws_five_scale_bucket) %>%
  summarise(heat_index_count_per_nws_five_scale_bucket=n()) %>%
  arrange(heat_index_nws_five_scale_bucket)

# For each target condition, calculate the number of hours between calls at each temperature level.  This metric allows us to account for the fact that simply counting calls in each bucket would be flawed, because it wouldn't adjust for the rarity of very hot temperatures. 

EMS_all %>%
  filter(primary_impression_group %in% conditions) %>%
  group_by(primary_impression_group, adjusted_heat_index_nws_five_scale_bucket) %>%
  summarise(condition_calls_count_per_bucket=n()) %>%
  inner_join(heat_index_count_per_nws_five_scale_bucket, by = c("adjusted_heat_index_nws_five_scale_bucket" = "heat_index_nws_five_scale_bucket")) %>%
  mutate(hours_per_call = heat_index_count_per_nws_five_scale_bucket/condition_calls_count_per_bucket) %>%
  select(primary_impression_group, adjusted_heat_index_nws_five_scale_bucket, hours_per_call) %>%
  spread(adjusted_heat_index_nws_five_scale_bucket, hours_per_call) %>%
  select(primary_impression_group, `not_unsafe_under_80`,`danger_103_124`)

```
### Fact: Morning temperature on July 19

"It was the morning of July 19, and the outdoor temperature would rise to 98 degrees."

#### Explanation
July 19 was particularly hot in Baltimore. By 2 p.m., the temperature at the Inner Harbor hit 98.1 degrees, using hourly averages, the hottest it would get all day.   

#### Supporting Code
``` {r}

 dmh %>%
  filter(`date` == date("2019-07-19")) %>%
  group_by(`date`) %>%
  summarise(max_temp = max(avg_hourly_temperature_dmh),
            max_heat_index = max(avg_hourly_heat_index_dmh)) 


```

### Fact: Extreme heat in Stephanie Pingley's house

"Pingley says that room can get as “hot as Hades,” which is reflected in readings of a sensor placed there. The heat index in that room climbed as high as 118 degrees and never dropped below 88 degrees for a seven-day stretch."

#### Explanation
The sensor readings taken inside of Stephanie Pingley's home reflect the extreme heat her family experienced.  The minimum indoor heat index value between July 16 and July 22 was 88 degrees, and the max was 118.  These values reflect minute by minute readings.  

#### Supporting Code

```{r}
stephanie_day_minute_averages %>%
  mutate(date=date(date_hour_minute)) %>%
  filter(date >= "2019-07-16",
         date <= "2019-07-22") %>%
  summarise(max_heat_index = max(mean_indoor_heat_index),
            min_heat_index = min(mean_indoor_heat_index))
 



```

### Fact: Extreme heat in Audrey DeWitt's House

"DeWitt has two units, one on the first floor near where she sleeps and another upstairs, but they don’t cool the entire house, she says. Despite the units, a sensor placed on the first floor by University of Maryland journalists recorded a heat index of 92 degrees at 6 a.m. on July 20."

"That was two degrees hotter than the heat index outdoors."

#### Explanation
Air conditioning window units, not uncommon in our reporting, often weren't enough to combat the heat.  In Audrey DeWitt's home, the heat index hit 91.8 degrees at 6 a.m. on July 20. 

``` {r}

audrey_day_hourly_averages %>%
  mutate(date=date(date_hour)) %>%
  mutate(hour=hour(date_hour)) %>%
  filter(date == "2019-07-20",
         hour == 6) 
```

Asthma rates in low-income areas like McElderry Park and Broadway East are higher than in more affluent areas,


Pingley says that room can get as “hot as Hades,” which is reflected in readings of a sensor placed there. The heat index in that room climbed as high as 118 degrees and never dropped below 88 degrees for a seven-day stretch.

```{r}

```
#### GRAPHICS

* https://amarton.github.io/2019-baltimore-climate-health-project-graphics-repo/health-leaflet-map/combined-maps.html
COME BACK TO THIS ONE, PROCESS HOSPITAL DATA

``` {r}
```

https://amarton.github.io/2019-baltimore-climate-health-project-graphics-repo/ems-calls-barcharts/emsCalls.html
NOTE NEW NUMBERS
```{r}

# Five-part NWS heat index danger scale
heat_index_count_per_nws_five_scale_bucket <- dmh_ems %>%
  select(heat_index_nws_five_scale_bucket) %>%
  group_by(heat_index_nws_five_scale_bucket) %>%
  summarise(heat_index_count_per_nws_five_scale_bucket=n()) %>%
  arrange(heat_index_nws_five_scale_bucket)

########### Five NWS Buckets #################
#### Table 1 | Primary Impression Group | Ratio Condition Calls v Heat Index | five NWS Buckets #####
# Ratio of number of calls for each condition type in each heat index bucket to total number of hours in each given temperature bucket. A lower number indicates a higher number of calls for each condition adjusted for the fact that some temperatures are simply more common than other others. It's 70 degrees for many more hours in a year than it is 110.  

conditions <- c("Cardiac Arrest", "COPD (Emphysema/Chronic Bronchitis)", "Dehydration", "Dizziness / Vertigo", "Hypertension", "Respiratory Distress", "Stroke/CVA", "Unconscious")


call_heat_index_ratio_five_primary_impression_group <- EMS_all %>%
  filter(primary_impression_group %in% conditions) %>%
  group_by(primary_impression_group, adjusted_heat_index_nws_five_scale_bucket) %>%
  summarise(condition_calls_count_per_bucket=n()) %>%
  inner_join(heat_index_count_per_nws_five_scale_bucket, by = c("adjusted_heat_index_nws_five_scale_bucket" = "heat_index_nws_five_scale_bucket")) %>%
  mutate(hours_per_call = heat_index_count_per_nws_five_scale_bucket/condition_calls_count_per_bucket) %>%
  select(primary_impression_group, adjusted_heat_index_nws_five_scale_bucket, hours_per_call) %>%
  spread(adjusted_heat_index_nws_five_scale_bucket, hours_per_call) %>%
  select(primary_impression_group, `not_unsafe_under_80`,`caution_80_89`,`extreme_caution_90_102`,`danger_103_124`)

ems_graphic <- call_heat_index_ratio_five_primary_impression_group

path_to_data <- "../data/output-data/cleaned/"

write_csv(ems_graphic, paste0(path_to_data,"ems_graphic.csv"))

```





