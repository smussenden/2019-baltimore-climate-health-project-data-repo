---
title: "Role of Trees Analysis"
author: "Roxanne Ready, Sean Mussenden | Howard Center for Investigative Journalism"
date: "8/6/2019"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 3
---

```{r include=FALSE}
# Save this file and run the following line from the Console to output both HTML and .md formats:
# rmarkdown::render('documentation/role-of-trees-data-analysis.Rmd', output_format = 'all')
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, paged.print=TRUE)
```

## LEFT TO DO:
_Search [SEAN] for unfinished sections_

## Introduction

This R markdown document describes the methodology and results of a portion of the data analysis we conducted in support of a reporting project examining the effects of tree canopy inequity across the city of Baltimore, especially as it relates to climate change.

Per editor request, this document is arranged in order of the facts as they appear in the story. Therefore, there is some recognized duplication of both code and facts.

## Setup

Before running this file, **please view and run the [Code Red Data Cleaning document](https://github.com/smussenden/2019-baltimore-climate-health-project-data-repo/blob/master/documentation/code-red-data-cleaning.md)** for this project. As well as outputting necessary cleaned data for the following ananlysis, that document also includes the following items necessary to understand this analysis: 

* definitions
* source data citation and information
* cleaning methodology 
* software tools used

### Load packages

```{r}
#######################
#### Load Packages ####
#######################

library(tidyverse)
library(DescTools) # For %like% operator
library(corrr) # For correlation matrices
library(colorspace) # For improved color palettes
library(ggplot2) # For graphing
library(ggrepel) # For graph labeling
require(scales) # For percent labeling on distribution tables

# Turn off scientific notation in RStudio (prevents coersion to character type)
options(scipen = 999)
```

### Store variables

```{r}
#########################
#### Store Variables ####
#########################

# Common path to data
path_to_data <- "../data/output-data/cleaned/"

# NSAs of interest
target_nsas <- c("Berea", "Broadway East", "Oliver", "Middle East", 
                 "Biddle Street","Milton-Montford", "Madison-Eastend", 
                 "CARE", "McElderry Park", "Ellwood Park/Monument", 
                 "Patterson Place", "Patterson Park Neighborhood", 
                 "Baltimore Highlands", "Highlandtown", 
                 "Upper Fells Point") %>%
                lapply(tolower)

# Counterpoint NSAs of interest
counterpoint_nsas <- c("Butcher's Hill", "Canton", "Washington Hill", "Roland Park") %>%
  lapply(tolower)

# CSAs of interest
target_csas <- c("Greater Roland Park/Poplar Hill", "Canton", "Patterson Park North & East", "Greenmount East", "Clifton-Berea") %>%
  lapply(tolower)

# Colorblind-friendly palette
cbPalette <- c("#999999", # Dark Gray
               "#E69F00", # Mustard Yellow
               "#56B4E9", # Sky Blue
               "#009E73", # Strong Green
               "#F0E442", # Lemon Yellow
               "#0072B2", # Denim Blue
               "#D55E00", # Rust Orange
               "#CC79A7") # Lavender
```

### Load data

```{r, warning=FALSE}
###################
#### Load Data ####
###################

blocks_tree_temp_demographics <- 
  read_csv(paste0(path_to_data, "blocks_tree_temp_demographics.csv")) %>%
  mutate_at(vars(matches("geoid10")), as.character) # Recast non-calculable variables as characters

csa_tree_temp_demographics <- 
  read_csv(paste0(path_to_data, "csa_tree_temp_demographics.csv"))

nsa_tree_temp <- 
  read_csv(paste0(path_to_data, "nsa_tree_temp.csv"))

zcta_tree_temp_demographics <- 
  read_csv(paste0(path_to_data, "zcta_tree_temp_demographics.csv")) %>%
  mutate_at(vars(matches("zcta")), as.character) # Recast non-calculable variables as characters

redlining_tree <- read_csv(paste0(path_to_data, "redlining_tree.csv"))

street_trees_nsa_categorized <- 
  read_csv(paste0(path_to_data, "street_trees_nsa_categorized.csv"))

street_trees_nsa_summarized <- 
  read_csv(paste0(path_to_data, "street_trees_nsa_summarized.csv"))

citywide_lidar_data <- read_csv(paste0(path_to_data, "citywide_2007_2015_lidar.csv"))

canopy_2007_2015_gains_losses <- read_csv(paste0(path_to_data, "canopy_2007_2015_gains_losses.csv"))

cctv_cameras_street_trees <- read_csv(paste0(path_to_data, "cctv_cameras_street_trees.csv"))

```

## Line-by-Line Facts

### Fact: Hottest Streets in Baltimore

"Kwamel Couther stands on the front lines of a campaign to bring thousands of cooling shade trees to some of the **hottest streets in Baltimore**."

#### Explanation

All of the top 10 hottest NSAs are located in the south of the city, and many are in the south-east.

#### Supporting Code

```{r, rows.print=10}

# Rank NSAs by temperature
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft) %>%
  mutate(rank = rank(-temp_mean_aft)) %>%
  arrange(rank)

```

### Fact: A certain block in Broadway East is one of the city's hottest

"He needs a lot of water too, working in the summer heat here at the edge of the **Broadway East** neighborhood, on one of the city’s **hottest** -- and poorest -- blocks."

#### Explanation

Below, we see the block on N. Milton Avenue between Oliver and Federal is one of the city's hottest, ranking at 236 out of 13,598 blocks. The  GEOID for this block was pulled from QGIS and breaks down into the following codes:

* State: 24
* County: 510
* Tract: 080301
* Block: 1000

#### Supporting Code

```{r}

# Block of interest ranked by heat
blocks_tree_temp_demographics %>%
  select(geoid10, temp_mean_aft) %>%
  mutate(rank = rank(-temp_mean_aft)) %>%
  filter(geoid10 == "245100803011000")

```

### Fact: Broadway East is one of the poorest NSAs

"He needs a lot of water too, working in the summer heat here at the edge of the **Broadway East** neighborhood, on one of the city’s hottest -- and **poorest** -- blocks."

#### Explanation

**Broadway East** ranked by percent of families living below the poverty line (out of 55 ranks). The Broadway East NSA is split vertically down the middle between the **Clifton-Berea** and **Greenmount East** CSAs, which also include large portions of the surrounding NSAs. It also includes an insignificant sliver of Oldtown/Middle East, which was disregarded in this analysis.

Broadway East, as a combination of Clifton-Berea and Greenmount East, has a total percent of family households living below the poverty line of `r round((csa_tree_temp_demographics$percent_of_family_households_living_below_the_poverty_line[csa_tree_temp_demographics$csa2010 %like% "%greenmount%"] +
csa_tree_temp_demographics$percent_of_family_households_living_below_the_poverty_line[csa_tree_temp_demographics$csa2010 %like% "%clifton%"]) / 2, 2)` according to:

#### Supporting Code

```{r}

# Average Clifton-Berea and Greenmount East CSAs to find Broadway East NSA
(csa_tree_temp_demographics$percent_of_family_households_living_below_the_poverty_line[csa_tree_temp_demographics$csa2010 %like% "%greenmount%"] +
csa_tree_temp_demographics$percent_of_family_households_living_below_the_poverty_line[csa_tree_temp_demographics$csa2010 %like% "%clifton%"]) / 2

```

```{r}

# The two CSAs that make up Broadway East average income and percent below poverty
csa_tree_temp_demographics %>%
  mutate(rank = rank(-percent_of_family_households_living_below_the_poverty_line)) %>%
  arrange(rank) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    T ~ NA_character_
  )) %>%
  select(csa2010, associated_nsa, 
         avg_household_income = median_household_income, 
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, 
         rank) %>%
  filter((csa2010 %like% "%clifton%") | 
           (csa2010 %like% "%greenmount%"))

```

### Fact: Poorest NSAs have less tree canopy

"The city’s **poorest** neighborhoods tend to have **less tree canopy than wealthier areas**..."

#### Discussion

A correlation matrix of poverty and canopy cover shows a negative correlation of -.34. In other words, places with a high poverty rate will have fewer trees, in general.

#### Supporting Code

```{r}

# Build correlation matrix between poverty and tree canopy
csa_tree_temp_demographics %>%
  select(perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         avg_canopy_2015 = `15_lid_mean`) %>%
  as.matrix() %>%
  correlate() %>%
  mutate(variable=rowname) %>%
  select(variable, everything(), -rowname)

```

### Fact: Canopy-to-poverty correlation is pronounced on the east side

"The city's poorest neighborhoods tend to have less tree canopy than wealthier areas, **a pattern that is especially pronounced on the concrete-dense east side**, in neighborhoods like **Broadway East**."

#### Explanation

Poverty, income and canopy at the top and bottom 10 CSAs when ranked for poverty.

#### Supporting Code

```{r, rows.print=20}

# Top and bottom 10 CSAs ranked for poverty, also showing tree canopy ranking
csa_tree_temp_demographics %>%
  select(csa2010,
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         avg_canopy_2015 = `15_lid_mean`) %>%
  mutate(rank_poverty = rank(-perc_below_poverty),
         rank_canopy = rank(-avg_canopy_2015)) %>%
  filter(between(rank_poverty, 1L, 10L) |
           between(rank_poverty, 46L, 55L)) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    (csa2010 %like% "%madison%") | (csa2010 %like% "%park north%") ~ "mcelderry park",
    (csa2010 %like% "%poplar%") ~ "roland park",
    T ~ NA_character_
  )) %>%
  select(csa2010,
         associated_nsa,
         perc_below_poverty,
         avg_canopy_2015,
         rank_poverty, rank_canopy) %>%
  arrange(rank_poverty)

```

### Fact: Coolest NSAs have 10x the canopy of hottest

"...the coolest neighborhoods have an order of magnitude more tree canopy than the hottest neighborhoods."

"...there was a 10-degree difference between the coolest and hottest neighborhoods in the city."

#### Explanation

An "order of magnitude" is an imprecise term but is generally considered to be 10. Whether the figure is 10 or approaching 10 depends on whether mean or median is used.

* McElderry Park was the hottest, at a mean of `r round(max(nsa_tree_temp$temp_mean_aft), 2)` and a median of `r round(max(nsa_tree_temp$temp_median_aft), 2)` degrees Fahrenheit.
* Gwynns Falls/Leakin Park was the coolest, at a mean of `r round(min(nsa_tree_temp$temp_mean_aft), 2)` and a median of `r round(min(nsa_tree_temp$temp_median_aft), 2)` degrees Fahrenheit.

The difference in temperatures between the city's mean hottest and coolest neighborhoods is `r round((min(nsa_tree_temp$temp_mean_aft)) - (max(nsa_tree_temp$temp_mean_aft)), 2)` degrees Fahrenheit, whereas the difference between median is `r round((min(nsa_tree_temp$temp_median_aft)) - (max(nsa_tree_temp$temp_median_aft)), 2)` degrees.

#### Supporting Code

```{r}

# The hottest and coolest NSAs
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft, temp_median_aft) %>%
  filter(
    ((temp_mean_aft == min(temp_mean_aft)) | (temp_mean_aft == max(temp_mean_aft))) |
    ((temp_median_aft == min(temp_median_aft)) | (temp_median_aft == max(temp_median_aft)))
         ) %>%
  arrange(desc(temp_mean_aft))

```

### Fact: 89 degrees at 1 p.m. on 7/10/2019

"By 1 p.m., when the heat index registered 89 degrees and the sun loomed almost directly overhead, working in the shade was no longer an option."

#### Explanation

[INCOMPLETE] [SEAN]

#### Supporting Code

```{r}

# Code here

```

### Fact: Street trees & plots on North Milton Ave.

"A 35-foot linden tree in the middle of the block once provided serious cover from the sun, but it died within the last few years."

"Across the street, another linden, a 25-footer, also appeared dead..."

"...under a 35-foot linden -- alive, but only in “fair” condition, as scored by the city -- with a broad leaf canopy. It was the only tree on the sidewalk to provide any meaningful temperature reduction..."

#### Explanation

All trees and potential tree locations along that stretch of road are referenced below.

#### Supporting Code

```{r, rows.print = 25}

# All street trees & locations along N. Milton in Broadway East
street_trees_nsa_categorized %>%
  filter((nbrdesc %like% "broadway%") & ((street %like% "n milton%"))) %>%
  select(nbrdesc, address, street, genus_clean, common, dbh, condition, date_inspected = inspect_dt) %>%
  arrange(street, address)

```

### Fact: Northern CSAs are both wealthier and cooler

"In the **wealthier**, more **temperate** neighborhoods **north of Broadway East** -- like **Roland Park** ... -- a 35-foot street tree like this would be of roughly average height, with plenty of company."

#### Explanation

Poverty and temperature shows a correlation of .398. In other words, poorer neighborhoods tend to be more temperate.

Secondly, the top and bottom 10 CSAs ranked for poverty in general show norther neighborhoods are both wealthier and cooler.

#### Supporting Code

```{r}

# Build correlation matrix between poverty and temperature
csa_tree_temp_demographics %>%
  select(perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         temp_mean_aft) %>%
  as.matrix() %>%
  correlate() %>%
  mutate(variable=rowname) %>%
  select(variable, everything(), -rowname)

```

```{r, rows.print=20}

# Top and bottom 10 CSAs ranked for poverty, also showing average temperature
csa_tree_temp_demographics %>%
  select(csa2010,
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         temp_mean_aft) %>%
  mutate(rank_poverty = rank(-perc_below_poverty),
         rank_temp = rank(-temp_mean_aft)) %>%
  filter(between(rank_poverty, 1L, 10L) |
           between(rank_poverty, 46L, 55L)) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    (csa2010 %like% "%madison%") | (csa2010 %like% "%park north%") ~ "mcelderry park",
    (csa2010 %like% "%poplar%") ~ "roland park",
    T ~ NA_character_
  )) %>%
  select(csa2010,
         associated_nsa,
         perc_below_poverty,
         temp_mean_aft,
         rank_poverty, rank_temp) %>%
  arrange(rank_poverty)

```

### Fact: Wealthier CSAs have many trees around 35 feet tall

"In the wealthier, more temperate **neighborhoods north of Broadway East** -- like **Roland Park** ... -- a **35-foot street tree** like this would be of **roughly average height**, with **plenty of company**."

#### Explanation

Roland Park has an average tree height of 30.86 feet. 42.8 percent of the trees there are 35 feet tall or taller.

#### Supporting Code

```{r, rows.print=19}

# See average height of trees in NSAs of interest
# and counts/percentages of trees greater than 35 feet tall
street_trees_nsa_categorized %>%
  select(nbrdesc, tree_ht) %>%
  group_by(nbrdesc) %>%
  summarize(avg_ht = mean(tree_ht),
            total_trees = n()) %>%
  left_join(
    street_trees_nsa_categorized %>%
    select(nbrdesc, tree_ht) %>%
    group_by(nbrdesc) %>%
    filter(tree_ht >= 35) %>%
    summarize(count_35_or_taller = n())
  ) %>%
  mutate(perc_35_or_taller = round(100*(count_35_or_taller/total_trees), 2)) %>%
  mutate(rank_avg_ht = rank(-avg_ht)) %>%
  filter((nbrdesc %in% target_nsas) | (nbrdesc %in% counterpoint_nsas)) %>%
  arrange(desc(avg_ht))

```

```{r}

# Plot height by of NSAs of interest using controled averages
street_trees_nsa_summarized %>%
  filter((nbrdesc %in% target_nsas) | (nbrdesc %in% counterpoint_nsas)) %>%
  ggplot(aes(x = reorder(nbrdesc, avg_ht_controled), 
           y = avg_ht_controled, 
           fill = factor(is_target_nsa, 
                         # Rename fill levels in legend
                         labels=c("Counterpoint NSA"," Target NSA"))
           )) +
  geom_col() +
  coord_flip() +
  labs(title = "Average Tree Height of Target NSAs",
       x = "",
       y = "",
       fill = "") +
  scale_fill_manual(values=cbPalette) +
  theme(legend.position = "bottom")

```

```{r, out.width='1000px'}

# Plot height for all NSAs using controled averages
# (For an overview, not intended for reading each NSA name)
ggplot(filter(street_trees_nsa_summarized, !is.na(avg_ht_controled)), 
       aes(x = reorder(nbrdesc, avg_ht_controled), 
           y = avg_ht_controled, 
           fill = factor(is_target_nsa, 
                         # Rename fill levels in legend
                         labels=c("Not Target NSA", "Target NSA"))
           )) +
  geom_col() +
  labs(title = "Average Tree Height of NSAs",
       x = "",
       y = "",
       fill = "") +
  scale_fill_manual(values=cbPalette) +
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 90, hjust = 1, size = 5))

```

### Fact: Broadway East lacks many 35-foot trees

"Here in **Broadway East**, in an area of Baltimore that has suffered from decades of disinvestment, this **lonely 35-footer stands out as one of the neighborhood’s largest sidewalk trees**."

#### Explanation

Broadway East has an average tree height of 5.75 feet. 5.24 percent of the trees there are 35 feet tall or taller.

#### Supporting Code

```{r}

# See average height of trees in Broadway East only
# and counts/percentages of trees greater than 35 feet tall
street_trees_nsa_categorized %>%
  select(nbrdesc, tree_ht) %>%
  group_by(nbrdesc) %>%
  summarize(avg_ht = mean(tree_ht),
            total_trees = n()) %>%
  left_join(
    street_trees_nsa_categorized %>%
    select(nbrdesc, tree_ht) %>%
    group_by(nbrdesc) %>%
    filter(tree_ht >= 35) %>%
    summarize(count_35_or_taller = n())
  ) %>%
  mutate(perc_35_or_taller = round(100*(count_35_or_taller/total_trees), 2)) %>%
  mutate(rank_avg_ht = rank(-avg_ht)) %>%
  filter(nbrdesc %like% "broadway%")

```

### Fact: Tree types living on N. Milton in Broadway East

"The rest of the living trees on this street -- 10-foot red maples, London planes and elms..."

#### Supporting Code

```{r, rows.print = 25}

# All street trees & locations along N. Milton in Broadway East
street_trees_nsa_categorized %>%
  filter((nbrdesc %like% "broadway%") & (street %like% "n milton%") & (condition != "absent")
         ) %>%
  select(nbrdesc, address, street, genus_clean, common, dbh, condition, tree_ht, date_inspected = inspect_dt) %>%
  arrange(street, address)

```

### Fact: Broadway East is a low-income neighborhood

"...in the heat of this low-income neighborhood."

#### Explanation

The CSAs that include Broadway East rank near the bottom in terms of average household income (at 45 and 48 out of 55) and percent below the poverty line (10 and 14).

#### Supporting Code

```{r}

# See how Broadway East CSAs rank in comparison to the other 53 CSAs in terms of poverty
csa_tree_temp_demographics %>%
  mutate(rank_avg_income = rank(-median_household_income),
         rank_perc_poverty = rank(-percent_of_family_households_living_below_the_poverty_line)) %>%
  arrange(rank_avg_income) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    T ~ NA_character_
  )) %>%
  select(csa2010, associated_nsa, 
         avg_household_income = median_household_income, 
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, 
         rank_avg_income,
         rank_perc_poverty) %>%
  filter(associated_nsa %like% "%broadway east%")

```

### Fact: McElderry Park temperature, wealth and canopy

"...McElderry Park, the city’s **hottest neighborhood** and also **among its poorest**. It also has some of the **lowest levels of tree canopy**..."

#### Explanation

The **McElderry Park** NSA is split horizontally across the middle between **Madison/East End** and **Patterson Park North & East**, both of which contain large portions of surrounding NSAs. 

The McElderry Park CSAs have a high poverty rate, are the first and third hottest CSAs, and have the 52nd and 51st least tree canopy.

#### Supporting Code

```{r}

csa_tree_temp_demographics %>%
  mutate(
    # Wealth
    rank_perc_poverty = rank(-percent_of_family_households_living_below_the_poverty_line),
    # Temperature
    rank_temp = rank(-temp_median_aft),
    # Canopy
    rank_canopy = rank(-`15_lid_mean`)
    ) %>%
  arrange(rank_perc_poverty) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%madison%") | (csa2010 %like% "%park north%") ~ "mcelderry park",
    T ~ NA_character_
  )) %>%
  select(csa2010, associated_nsa,
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, 
         rank_perc_poverty,
         temp_median_aft,
         rank_temp,
         canopy_2015 = `15_lid_mean`,
         rank_canopy
         ) %>%
  filter(associated_nsa %like% "%mcelderry park%")

```

### Fact: Broadway East is one of the hottest neighborhoods

"A future where **the hottest city neighborhoods, like Broadway East**, have the kind of dense canopy that help keep places like Roland Park cool as global temperatures rise."

#### Explanation

Broadway East is the 16th-hottest NSA out of 278.

#### Supporting Code

```{r}

# Broadway East ranked by mean afternoon heat
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft) %>%
  mutate(rank = rank(-temp_mean_aft)) %>%
  filter(nsa_name == "broadway east")

```


### Fact: Roland Park has dense canopy and is cool

"A future where the hottest city neighborhoods, like Broadway East, have the kind of **dense canopy that help keep places like Roland Park cool** as global temperatures rise."

#### Explanation

Roland Park is ranked 9th-most dense and 263rd-hottest, out of 278 NSAs.

#### Supporting Code

```{r}

# Roland Park ranked by mean afternoon heat and amount canopy cover
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft, avg_canopy = `15_lid_mean`) %>%
  mutate(rank_temp = rank(-temp_mean_aft),
         rank_canopy = (rank(-avg_canopy))) %>%
  filter(nsa_name %like% "roland%")

```

### Fact: 2/3 of Roland Park is covered in canopy

"Two-thirds of the neighborhood [Roland Park] is covered with tree canopy in the summer."

#### Explanation

Roland Park has an average of .65 percent canopy cover.

#### Supporting Code

```{r}

# Roland Park's average canopy cover
nsa_tree_temp %>%
  select(nsa_name, avg_canopy = `15_lid_mean`) %>%
  filter(nsa_name %like% "roland%")

```

### Fact: Broadway East has about 10% canopy, 6x Roland Park

"Broadway East has about 10% canopy coverage. That’s 6 times less than Roland Park."

#### Supporting Code

```{r}

# Broadway East and Roland Park's average canopy cover
nsa_tree_temp %>%
  select(nsa_name, avg_canopy = `15_lid_mean`) %>%
  filter((nsa_name %like% "broadway%") | (nsa_name %like% "roland%"))

```

### Fact: Inverse relationship between tree cover and temperature

"Trees have a big impact on temperature."

"That’s one reason Baltimore’s tree canopy map looks like a photonegative of this map, showing the difference in  summer temperature averages by neighborhood."

#### Explanation

When comparing temperature to tree canopy, we see a strong correllation of -.89. In other words, places with high temperatures tend to have fewer trees. This negative correllation confirms the visual representation in the story.

#### Supporting Code

```{r}

# Correlation matrix of temperature to canopy cover
csa_tree_temp_demographics %>%
  select(temp_mean_aft,
         avg_canopy_2015 = `15_lid_mean`) %>%
  as.matrix() %>%
  correlate() %>%
  mutate(variable=rowname) %>%
  select(variable, everything(), -rowname)

```

```{r}

# Canopy and afternoon temperature averages across neighborhoods
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft, avg_canopy_2015 = `15_lid_mean`)

```

### Fact: Roland park is one of the coolest NSAs, Broadway East is one of the hottest

"Roland Park is one of the coolest."

"Broadway East is one of the hottest."

#### Explanation

Roland Park and Broadway East are ranked at 263 and 16, respectively, in terms of temperature, out of 278 NSAs.

#### Supporting Code

```{r}

# Afternoon temperature averages of Roland Park and Broadway East
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft) %>%
  mutate(temp_rank = rank(-temp_mean_aft)) %>%
  filter((nsa_name %like% "roland%") | (nsa_name %like% "broadway%"))

```

### Fact: About 1/4 of families in Broadway East live in poverty

"Broadway East, with approximately 1 in 4 families below the poverty line..."

#### Explanation

When both CSAs containing Broadway East are combined, they show an average of 25.9 percent of families living below the poverty line.

#### Supporting Code

```{r}

# The two CSAs that make up Broadway East average percent below poverty
csa_tree_temp_demographics %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    T ~ NA_character_
  )) %>%
  filter(associated_nsa == "broadway east") %>%
  group_by(associated_nsa) %>%
  summarize(avg_below_poverty_line = mean(percent_of_family_households_living_below_the_poverty_line))

```

### Fact: Broadway East is one of the poorest NSAs

"Broadway East... is also among the poorest neighborhoods."

#### Explanation

The CSAs that include Broadway East rank near the bottom in terms of average household income (at 45 and 48 out of 55).

#### Supporting Code

```{r}

# See how Broadway East CSAs rank in comparison to the other 53 CSAs in terms of poverty
csa_tree_temp_demographics %>%
  mutate(rank_avg_income = rank(-median_household_income)) %>%
  arrange(rank_avg_income) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    T ~ NA_character_
  )) %>%
  select(csa2010, associated_nsa, 
         avg_household_income = median_household_income, 
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, 
         rank_avg_income) %>%
  filter(associated_nsa %like% "%broadway east%")

```

### Fact: Poorer neighborhoods have less tree cover, with some exceptions

"In Baltimore, as in several other cities, poorer neighborhoods tend to have less tree cover than wealthier areas."

#### Explanation

A correlation matrix of poverty and canopy cover shows a negative correlation of -.34. In other words, places with a high poverty rate will have fewer trees, in general.

There are some exceptions to this trend, such as Penn North/Reservoir Hill and Greater Rosemont, which both have relatively high rates of both poverty and tree canopy.

#### Supporting Code

```{r}

# Correlation matrix between poverty and tree canopy
csa_tree_temp_demographics %>%
  select(perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         avg_canopy_2015 = `15_lid_mean`) %>%
  as.matrix() %>%
  correlate() %>%
  mutate(variable=rowname) %>%
  select(variable, everything(), -rowname)

```
```{r}

# Poverty to canopy GRAPH
csa_tree_temp_demographics %>%
  # Start ggplot and set x and y for entire plot
  ggplot(aes(
    x = percent_of_family_households_living_below_the_poverty_line/100, 
    y = `07_lid_mean`
    )) +
  # This section for the basic scatterplot
  geom_point(aes(color = `07_lid_mean`),
             size=4) +
  # This section for circling all sample neighborhood points
  geom_point(data = csa_tree_temp_demographics %>%
               filter((csa2010 %in% target_csas) 
                      # Patterson Park must be included seperately because of its unique label positioning
                      | (csa2010 == "Patterson Park North & East") 
                      ),
             aes(color = `07_lid_mean`),
             size=6, shape = 1) +
  # This section shows the trend line
  geom_smooth(se = FALSE, # Removes gray banding
              method = glm, 
              color = "black") +
  # This section for labeling Canton, etc.
  ggrepel::geom_label_repel(data = csa_tree_temp_demographics %>%
                              filter(csa2010 %in% target_csas) %>%
                              mutate(csa2010 = case_when(
                                csa2010 == "Greenmount East" ~ "Greenmount East \n(includes part of Broadway East)", 
                                csa2010 == "Clifton-Berea" ~ "Clifton-Berea \n(includes part of Broadway East)",
                                T ~ csa2010)),
            aes(label = csa2010),
            min.segment.length = .1,
            segment.alpha = .5,
            alpha = .85,
            nudge_x = .05,
            nudge_y = .06) +
  # This section for labeling Patterson Park (so it can be nudged)
  ggrepel::geom_label_repel(data = csa_tree_temp_demographics %>%
                              filter(csa2010 == "Patterson Park North & East") %>%
                              mutate(csa2010 = case_when(
                                csa2010 == "Patterson Park North & East" ~ "Patterson Park North & East \n(includes most of McElderry Park)",
                                T ~ csa2010)),
                            aes(label = csa2010),
                            min.segment.length = .1,
                            segment.alpha = .5,
                            alpha = .85,
                            nudge_x = -.06,
                            nudge_y = .03) +
  # Colors and label formatting follow
  #coord_flip() +
  scale_colour_gradient(low = "#E0FEA9", high = "#144A11") +
  labs(title = "Poverty to Tree Canopy",
       subtitle = "Percent of households living below the poverty line \ncompared to the percent of tree cover in the area",
       x = "Percent of households living below the poverty line",
       y = "Percent of land covered by trees") +
  scale_x_continuous(label = scales::percent_format(accuracy = 1.0),
                     breaks = seq(0, 1, .1)) + 
  scale_y_continuous(label = scales::percent_format(accuracy = 1.0),
                     breaks = seq(0, 1, .1)) + 
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 12))

```

```{r, columns.print=5}

# Show exceptions to poverty/canopy correlation
csa_tree_temp_demographics %>%
  select(csa2010, 
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line,
         avg_canopy_2015 = `15_lid_mean`) %>%
  mutate(rank_perc_poverty = rank(-perc_below_poverty),
         rank_perc_canopy = rank(-avg_canopy_2015)) %>%
  arrange(rank_perc_canopy) %>%
  filter((csa2010 %like% "%penn north%") | (csa2010 %like% "%rosemont%"))

```


### Fact: Broadway East and Roland Park canopy correlates to historic redlining

"Most of Roland Park ... was classified as “still desirable,” with some parts labeled “best” and others as “definitely declining.""

"Broadway East ... was labeled “definitely declining” and “hazardous.”"

#### Explanation

For this section, reporters looked at overlapping shapefiles in QGIS and made determinations visually. _[SEAN] may run computations later_.

#### Supporting Code

```{r}

# Summaries of canopy-to-area percent for each redlining classification
redlining_tree %>%
  group_by(holc_grade, grade_descr) %>%
  summarise(total_area_pixels = sum(`count_all_pix_15`),
            total_canopy_pixels = sum(`sum_canopy_pix_15`)) %>%
  mutate(avg_canopy_perc = round(100*(total_canopy_pixels/total_area_pixels), 2))
```

### Fact: Roland Park is one of Baltimore's wealthiest and whitest; Broadway East is one of the poorest and blackest

"Most of Roland Park -- today one of the wealthiest and whitest parts of Baltimore..."

"Broadway East -- today one of the poorest parts of Baltimore, with one of the highest percentages of African Americans..."

#### Explanation

Roland Park is ranked 53 of 55 for percent of people living below the poverty line, and 3rd of 55 for percent of white residents.

Broadway East -- split between Clifton-Berea and Greenmount East -- is ranked 10th/14th for poverty and 10th/9th for percent of black residents.

#### Supporting Code

```{r}

# Show poverty and race in Roland Park and Broadway East
# compared to other neighborhoods
csa_tree_temp_demographics %>%
  select(csa2010, 
         perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, 
         perc_white = percent_of_residents_white_caucasian_non_hispanic,
         perc_black = percent_of_residents_black_african_american_non_hispanic,
         racial_diversity_index) %>%
  mutate(associated_nsa = case_when(
    (csa2010 %like% "%clifton%") | (csa2010 %like% "%greenmount%") ~ "broadway east",
    (csa2010 %like% "%madison%") | (csa2010 %like% "%park north%") ~ "mcelderry park",
    (csa2010 %like% "%poplar%") ~ "roland park",
    T ~ NA_character_
  )) %>%
  mutate(rank_poverty = rank(-perc_below_poverty),
         rank_black = rank(-perc_black),
         rank_white = rank(-perc_white)) %>%
  filter(csa2010 %in% target_csas) %>%
  select(csa2010, associated_nsa, rank_poverty, rank_black, rank_white, everything()) %>%
  arrange(associated_nsa)

```


### Fact: Baltimore tree cover went from 27% in 2007 to 28% in 2015

"Baltimore was at 28% in 2015, up from 27% in 2007."

#### Explanation

This statistic is according to researchers with the U.S. Forest Service and the University of Vermont. Our analysis shows a smaller change.

#### Supporting Code

```{r}

# Calculate citywide canopy change
citywide_lidar_data %>%
  rename_all(tolower) %>%
  mutate_if(is.character, tolower) %>%
  select(county, `07_mean`, `15_mean`) %>%
  mutate(real_change = round(`15_mean` - `07_mean`, 4),
         perc_change = round((`15_mean` - `07_mean`)/`07_mean`, 4)
         )

```

### Fact: Hot East Baltimore NSAs are nowhere near 40% canopy

"Even with a flurry of planting in recent years, Broadway East and other hot East Baltimore neighborhoods are nowhere near 40%..."

#### Explanation

Of the NSAs of interest, only two are above 10% canopy cover.

#### Supporting Code

```{r, rows.print=15}

# Calculate average canopy percent of area in NSAs of interest
nsa_tree_temp %>%
  select(nsa_name, mean_canopy_2015 = `15_lid_mean`) %>%
  filter(nsa_name %in% target_nsas) %>%
  mutate(avg_canopy_perc_2015 = round((mean_canopy_2015)*100, 2)) %>%
  select(-mean_canopy_2015)

```

### Fact: Canopy growth has been "measured"

"...canopy growth has been relatively measured despite recent planting efforts."

#### Explanation

As shown above, the canopy has only increased by a small amount.

#### Supporting Code

```{r}

# Calculate citywide canopy change
citywide_lidar_data %>%
  rename_all(tolower) %>%
  mutate_if(is.character, tolower) %>%
  select(county, `07_mean`, `15_mean`) %>%
  mutate(real_change = round(`15_mean` - `07_mean`, 4),
         perc_change = round((`15_mean` - `07_mean`)/`07_mean`, 4)
         )

```


### Fact: 1/3 of Broadway East blocks lost canopy cover, but overall canopy increased by 1.6 points; Roland Park increased by 2.1 points

"Between 2007 and 2015, about a third of blocks in Broadway East lost tree canopy cover, while about two-thirds gained. Overall, tree canopy in Broadway East grew 1.6 percentage points, from 9% to 10.6%, over those eight years."

"Roland Park, already covered with trees, grew by 2.1 percentage points."

#### Supporting Code

```{r rows.print=19}

# NSAs of interest in terms of average canopy and change as percentage point
nsa_tree_temp %>%
  select(nsa_name, `07_lid_mean`, `15_lid_mean`, lid_change_percent_point) %>%
  filter((nsa_name %in% target_nsas) | (nsa_name %in% counterpoint_nsas)) %>%
  mutate(lid_change_percent_point = round(lid_change_percent_point*100, 2),
         `07_lid_mean` = round(`07_lid_mean`*100, 2),
         `15_lid_mean` = round(`15_lid_mean`*100, 2)) %>%
  rename(avg_canopy_2007 = `07_lid_mean`,
         avg_canopy_2015 = `15_lid_mean`,
         change_perc_point = lid_change_percent_point
         )

```

### Fact: Citywide canopy loss and gain

"While some neighborhoods showed gains and others, losses, the net gain was about 1%."

#### Explanation

Using shapefiles, reporters calculated the percent of land area occupied by canopy that were tagged as canopy gained and canopy lost.

#### Supporting Code

```{r}

# Calculate gains and losses as percentages of the total area
canopy_2007_2015_gains_losses %>%
  # Clean
  rename_all(tolower) %>%
  mutate_if(is_character, tolower) %>%
  # Categorize
  group_by(class) %>%
  summarise(totals = sum(shape_area)) %>%
  spread(class, totals) %>%
  rename(no_change = `no change`) %>%
  # Calculate
  mutate(old_07 = loss + no_change) %>%
  mutate(gain_as_perc = (gain/old_07)*100,
         loss_as_perc = (loss/old_07)*100,
         difference = round(gain_as_perc - loss_as_perc, 2))

```

### Fact: 

"Those gains and losses were not distributed equitably. About 40% of city neighborhoods had net losses. The rest had net gains..."

```{r}

# Count and percent of NSAs that gained and lost canopy
as.data.frame(table(sign(nsa_tree_temp$lid_change_percent))) %>%
  mutate(total = sum(Freq),
         perc = round(100*(Freq/total), 2)) %>%
  mutate(type = case_when(
    Var1 == -1 ~ "losses",
    Var1 == 1 ~ "gains",
    T ~ NA_character_
  )) %>%
  select(
    type,
    number = Freq,
    total, perc
  )


```

### Fact: The hottest NSAs did not grow enough to correct canopy inequity

"...none of Baltimore’s hottest neighborhoods saw enough growth to even approach correcting the [tree canopy] inequity."

#### Supporting Code

```{r rows.print=19}

# NSAs of interest in terms of average canopy and change as percentage point
# and ranked by temperature out of 278 NSAs
nsa_tree_temp %>%
  select(nsa_name, temp_mean_aft, `07_lid_mean`, `15_lid_mean`, lid_change_percent_point) %>%
  mutate(rank_by_temp =rank(-temp_mean_aft)) %>%
  filter((nsa_name %in% target_nsas) | (nsa_name %in% counterpoint_nsas)) %>%
  mutate(lid_change_percent_point = round(lid_change_percent_point*100, 2),
         `07_lid_mean` = round(`07_lid_mean`*100, 2),
         `15_lid_mean` = round(`15_lid_mean`*100, 2)) %>%
  rename(avg_canopy_2007 = `07_lid_mean`,
         avg_canopy_2015 = `15_lid_mean`,
         change_perc_point = lid_change_percent_point
         ) %>%
  select(nsa_name, temp_mean_aft, rank_by_temp, everything())

```

### Fact: Broadway East has ~1,000 spaces to put a tree, but most require breaking concrete

"The city has identified about a thousand spaces in Broadway East where new trees could go, but 96% are currently covered by sidewalk."

#### Supporting Code

```{r, columns.print=7}

# Find percent of suitable spaces at each difficulty level for Broadway East
street_trees_nsa_categorized %>%
  # Count the spaces at each level
  select(nbrdesc, difficulty_level_num, difficulty_level) %>%
  filter((nbrdesc %like% "broadway%") & (difficulty_level != "has live tree")) %>%
  group_by(nbrdesc, difficulty_level_num, difficulty_level) %>%
  summarize(count_spaces = n()) %>%
  ungroup() %>%
  mutate(total_vacant_spaces = sum(count_spaces)) %>%
  # Count the suitable spaces in Broadway East
  left_join(
    street_trees_nsa_categorized %>%
      select(nbrdesc, difficulty_level_num, difficulty_level) %>%
      filter((nbrdesc %like% "broadway%") & (difficulty_level != "has live tree") & (difficulty_level != "unsuitable")) %>%
      group_by(nbrdesc, difficulty_level_num, difficulty_level) %>%
      summarize(count_suitable = n()) %>%
      ungroup() %>%
      mutate(total_suitable = sum(count_suitable)) %>%
      select(-count_suitable)
  ) %>%
  # Calculate the percent of suitable spaces at each difficulty
  mutate(perc_at_difficulty = round(100*(count_spaces/total_suitable), 2))

```

### Fact: There is a 35-foot Callery pear tree in front of a specific house on E. Lanvale St. in fair condition

"...the 35-foot Callery pear tree in front of Mary Boyd’s rowhouse on East Lanvale Street in Broadway East..."

"Her pear tree is in “fair” condition, according to the city."

#### Explanation

Every tree on the Broadway East stretch of E. Lanvale St. is listed below.

#### Supporting Code

```{r, rows.print = 25}

street_trees_nsa_categorized %>%
  filter(
    ((nbrdesc %like% "broadway%") & (street %like% "%lanvale%")) &
      (condition != "absent")
    ) %>%
  select(nbrdesc, address, street, genus_clean, common, dbh, tree_ht, condition, date_inspected = inspect_dt) %>%
  arrange(street, address)

```

### Fact: A 35-foot tree is unusual in Broadway East and average for Roland Park

"This [35-foot Callery pear tree in front of Mary Boyd’s rowhouse on East Lanvale Street in Broadway East is] exemplary for Broadway East, average in Roland Park..."

#### Explanation

Roland Park has a high percentage of trees 35 feet tall and taller; Broadway East has a low percentage. The average height of trees in Roland Park is about 31 feet. In Broadway East, it's about 6 feet.

#### Supporting Code

```{r}

# See average height of trees in Broadway East and Roland Park
# and counts/percentages of trees greater than 35 feet tall
street_trees_nsa_categorized %>%
  select(nbrdesc, tree_ht) %>%
  group_by(nbrdesc) %>%
  summarize(avg_ht = mean(tree_ht),
            total_trees = n()) %>%
  left_join(
    street_trees_nsa_categorized %>%
    select(nbrdesc, tree_ht) %>%
    group_by(nbrdesc) %>%
    filter(tree_ht >= 35) %>%
    summarize(count_35_or_taller = n())
  ) %>%
  mutate(perc_35_or_taller = round(100*(count_35_or_taller/total_trees), 2)) %>%
  mutate(rank_avg_ht = rank(-avg_ht)) %>%
  filter((nbrdesc %like% "roland%") | (nbrdesc %like% "broadway%")) %>%
  arrange(desc(avg_ht))

```

### Fact: Number, condition and height of other trees on the E. Lanvale St. block

"There are two other trees on her side of the block, a pair of 35-foot red maples. The city graded them in poor condition and has identified the trees -- and their thinning canopy -- for removal."

#### Explanation

According to [the data schema]("https://github.com/smussenden/2019-baltimore-climate-health-project-data-repo/blob/master/documentation/street-tree-inventory-spec-sheet.pdf") provided by Baltimore City Recreation & Parks, page 11, a "tree removal" value in the "Maintenance Needs" field means: "Tree must be removed. The tree is either dead, or no remedial action can alleviate the poor condition of a tree."

#### Supporting Code

```{r}

# All trees along the Broadway East stretch of E. Lanvale St.
street_trees_nsa_categorized %>%
  filter(
    ((nbrdesc %like% "broadway%") & (street %like% "%lanvale%")) &
      (condition != "absent")
    ) %>%
  select(nbrdesc, address, street, genus_clean, common, dbh, tree_ht, condition, mt, date_inspected = inspect_dt) %>%
  arrange(common, address)

```

### Fact: Trees in Broadway East are less healthy than those in Roland Park and similar NSAs

"Unfortunately, the larger street trees in this neighborhood are simply less healthy than they are in cooler neighborhoods to the north. Less than half of trees with a trunk larger than 6 inches in diameter were labeled “good” by the city’s most recent street tree census, compared to about 75% in Roland Park."

#### Explanation

When looking at larger trees, Roland Park is ranked 28th in for percent in good condition. Broadway East, by contrast, is ranked 227th of 277 NSAs.

#### Supporting Code

```{r, rows.print = 19}

# Find counts of each tree condition in NSAs of interest, and calculate the percentage that are in good condition
street_trees_nsa_categorized %>%
  select(nbrdesc, diameter = dbh, condition) %>%
  # Filter for only trees with diameter larger than 6 inches
  filter(diameter > 6) %>%
  group_by(nbrdesc, condition) %>%
  summarize(count_at_condition = n()) %>%
  spread(condition, count_at_condition) %>%
  # Drop non-live trees
  select(-absent, -unknown, -dead, -stump) %>%
  # Arrange in sensible order
  select(poor, fair, good) %>%
  ungroup() %>%
  # Find percent
  mutate(total_live_trees = rowSums(.[2:4]),
         perc_good = round(100*(good/total_live_trees), 2)) %>%
  arrange(desc(perc_good)) %>%
  # Rank by percent
  mutate(rank_by_perc_good = rank(-perc_good)) %>%
  # Filter for NSAs of interest
  filter((nbrdesc %in% target_nsas) | (nbrdesc %in% counterpoint_nsas))

```

### Fact: The BPD has requested at least around 100 trees be trimmed to clear CCTV views

"Since early 2018, trees were removed or trimmed back nearly 100 times across the city at the request of the police department, records show, including one a few blocks south of Broadway East."

#### Explanation

At least `r nrow(cctv_cameras_street_trees)` trees have been marked for trimming or removal since early 2018.

#### Code

```{r, rows.print = 15}

nrow(cctv_cameras_street_trees)

```

### Fact: The poorest CSAs have higher crime rates

"In Baltimore’s poorest neighborhoods, which generally have higher crime rates..."

#### Supporting Code

```{r, rows.print = 25}

# Show CSAs arranged by percent_of_family_households_living_below_the_poverty_line to compare to rates of violent crime
csa_tree_temp_demographics %>%
  select(csa2010, perc_below_poverty = percent_of_family_households_living_below_the_poverty_line, violent_crime_rate_per_1_000_residents) %>%
  arrange(desc(perc_below_poverty))

```

### Fact: ~1/3 of Broadway East homes are vacant

"In Broadway East, nearly a third of homes are vacant..."

#### Explanation

[INCOMPLETE] [SEAN]

#### Supporting Code

```{r}

# Code here

```


